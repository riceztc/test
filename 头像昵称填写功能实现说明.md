# 头像昵称填写功能实现说明

## 📋 功能概述

根据微信官方公告，从2022年2月21日24时起，平台收回了通过 `<open-data>` 组件展示个人信息的能力。本实现采用微信官方推荐的 **头像昵称填写功能**，使用 `wx.getUserProfile` 接口获取用户信息，并使用 `image` 组件显示用户头像。

## 🔧 技术实现

### 1. 核心API：wx.getUserProfile

```javascript
wx.getUserProfile({
  desc: '用于完善会员资料，展示头像昵称',
  success: (res) => {
    // 获取用户信息成功
    this.setData({
      userInfo: res.userInfo,
      hasUserInfo: true
    })
  }
})
```

**关键特性：**
- 需要基础库 2.10.4 及以上
- 每次调用都需要用户确认
- 返回真实的用户信息（avatarUrl、nickName等）
- 推荐使用本地存储避免重复弹窗

### 2. 版本兼容性处理

```javascript
// 检查是否支持getUserProfile
if (wx.getUserProfile) {
  this.setData({
    canIUseGetUserProfile: true
  })
} else {
  // 使用旧版本方案
  wx.getUserInfo({
    success: (res) => {
      // 处理用户信息
    }
  })
}
```

### 3. 用户信息缓存机制

```javascript
// 缓存用户信息，避免重复授权弹窗
try {
  wx.setStorageSync('userInfo', res.userInfo)
} catch (err) {
  console.error('缓存用户信息失败:', err)
}

// 页面加载时检查缓存
checkCachedUserInfo() {
  const cachedUserInfo = wx.getStorageSync('userInfo')
  if (cachedUserInfo && cachedUserInfo.avatarUrl) {
    this.setData({
      userInfo: cachedUserInfo,
      hasUserInfo: true
    })
  }
}
```

## 📱 用户界面实现

### 1. 模板结构

```xml
<!-- 未授权状态 -->
<button wx:if="{{canIUseGetUserProfile}}" bindtap="getUserProfile">
  获取头像昵称
</button>

<!-- 已授权状态 -->
<block wx:else>
  <image src="{{userInfo.avatarUrl}}" mode="cover"></image>
  <text>{{userInfo.nickName}}</text>
</block>
```

### 2. 样式优化

```css
.userinfo-avatar {
  width: 160rpx;
  height: 160rpx;
  border-radius: 50%;
  border: 6rpx solid #fff;
  box-shadow: 0 8rpx 25rpx rgba(0, 0, 0, 0.15);
  transition: transform 0.2s ease;
}

.userinfo-nickname {
  font-size: 32rpx;
  color: #333;
  font-weight: 500;
  max-width: 300rpx;
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
}
```

## 🔄 工作流程

1. **页面加载**
   - 检查是否支持 `wx.getUserProfile`
   - 检查本地缓存的用户信息
   - 显示相应状态

2. **用户授权**
   - 用户点击"获取头像昵称"按钮
   - 调用 `wx.getUserProfile` 接口
   - 用户确认授权

3. **信息展示**
   - 获取成功后保存用户信息
   - 使用 `image` 组件显示头像
   - 使用 `text` 组件显示昵称
   - 缓存信息避免重复授权

## 🚀 优势特点

1. **符合官方规范**：使用微信推荐的 `wx.getUserProfile` 接口
2. **用户友好**：清晰的授权说明和反馈
3. **性能优化**：本地缓存避免重复弹窗
4. **版本兼容**：支持不同版本的基础库
5. **样式美观**：现代化的UI设计和交互效果

## ⚠️ 注意事项

1. **基础库版本**：需要基础库 2.10.4 及以上
2. **用户授权**：每次调用都需要用户确认
3. **信息存储**：妥善保管用户头像和昵称
4. **隐私保护**：仅在必要时请求用户授权
5. **错误处理**：完整的错误处理和用户引导

## 🔄 替代方案对比

| 方案 | 优点 | 缺点 | 推荐度 |
|------|------|------|--------|
| `wx.getUserProfile` | 官方推荐、安全可靠 | 需要用户主动授权 | ⭐⭐⭐⭐⭐ |
| `<open-data>` | 无需授权 | 已被平台收回 | ❌ |
| 手动输入 | 控制灵活 | 用户体验差 | ⭐⭐ |

## 📚 相关文档

- [微信官方文档：wx.getUserProfile](https://developers.weixin.qq.com/miniprogram/dev/api/open-api/user-info/wx.getUserProfile.html)
- [用户头像昵称获取规则调整公告](https://developers.weixin.qq.com/community/develop/doc/00022c683e8a80b29bed2142b56c01)
- [用户信息接口调整说明](https://developers.weixin.qq.com/community/develop/doc/000cacfa20ce88df04cb468bc52801)

---

**实现时间**：2025年12月10日  
**技术栈**：微信小程序、wx.getUserProfile、本地存储  
**兼容性**：支持基础库 2.10.4 及以上版本