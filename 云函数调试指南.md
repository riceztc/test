# 云函数调试指南

## 🚨 添加失败问题排查

### 步骤1: 检查详细错误信息
现在重新尝试添加账单，查看控制台输出的详细错误信息。

### 步骤2: 检查云函数是否正确上传

1. **打开微信开发者工具**
2. 在左侧文件树中找到 `cloudfunctions` 文件夹
3. 右键点击 `addBill` 文件夹
4. 选择"上传并部署：云端安装依赖"
5. 等待上传完成，状态显示为"已上传"

**重复以上步骤上传所有云函数：**
- `getBills`
- `addBill`
- `getBillDetail`
- `updateBill`
- `deleteBill`
- `getTodayStats`

### 步骤3: 检查数据库集合

1. 点击工具栏的"云开发"按钮
2. 选择"数据库"
3. 检查是否存在 `bills` 集合
4. 如果不存在，点击"新建集合"
   - 集合名称: `bills`
   - 权限设置: "所有用户可读，仅创建者可写"

### 步骤4: 检查环境ID

1. 打开 `app.js` 文件
2. 确认环境ID是否正确:
```javascript
wx.cloud.init({
  env: 'cloud1-6gjyjg4p7776e793', // 确保这是你的真实环境ID
  traceUser: true,
})
```

3. 如果不确定环境ID，可以：
   - 点击"云开发" → "设置" → "环境设置"
   - 复制"环境ID"

### 步骤5: 测试云函数

在开发者工具控制台中直接测试云函数：

```javascript
// 测试添加账单
wx.cloud.callFunction({
  name: 'addBill',
  data: {
    title: '测试账单',
    amount: '10.00',
    type: '支出',
    remark: '测试备注'
  },
  success: res => {
    console.log('测试结果:', res)
  },
  fail: err => {
    console.log('测试失败:', err)
  }
})
```

### 步骤6: 检查数据库权限

1. 在云开发控制台 → 数据库 → `bills` 集合
2. 点击"权限设置"
3. 确保权限为："所有用户可读，仅创建者可写"

## 🔧 常见错误及解决方案

### 错误1: "云函数不存在"
**原因**: 云函数未上传或上传失败
**解决**: 重新上传云函数

### 错误2: "权限不足"
**原因**: 数据库权限设置错误
**解决**: 修改集合权限为"所有用户可读，仅创建者可写"

### 错误3: "集合不存在"
**原因**: 未创建 `bills` 集合
**解决**: 在数据库中创建 `bills` 集合

### 错误4: "环境ID不存在"
**原因**: 环境ID配置错误
**解决**: 更新 `app.js` 中的环境ID

## 🧪 快速修复步骤

如果以上检查都正常，可以尝试以下快速修复：

1. **删除云函数重新上传**:
   - 在云开发控制台删除所有云函数
   - 在开发者工具中重新上传

2. **重置数据库**:
   - 删除 `bills` 集合
   - 重新创建并设置权限

3. **清除缓存**:
   - 开发者工具 → 工具 → 清除缓存 → 清除所有缓存

## 📱 临时解决方案

如果云函数暂时无法正常工作，可以在前端添加模拟数据：

```javascript
// 在 addBill 函数中添加临时代码
addBill(billData) {
  // 临时模拟添加成功
  console.log('模拟添加:', billData)
  wx.showToast({
    title: '添加成功（模拟）',
    icon: 'success'
  })
  setTimeout(() => {
    wx.navigateBack()
  }, 1500)
  return
  
  // 原来的云函数代码暂时注释...
}
```

这样可以先测试界面逻辑，等云函数问题解决后再恢复。

## 🎯 调试建议

1. **先测试简单功能**: 从获取列表开始测试
2. **查看详细日志**: 每一步都要查看控制台输出
3. **分步调试**: 一次只测试一个功能
4. **使用模拟数据**: 云函数有问题时先用模拟数据

记住：云开发的调试需要耐心，仔细按照步骤检查通常都能解决问题！